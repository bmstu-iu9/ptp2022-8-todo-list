package db

import (
	"database/sql"
	"fmt"

	"github.com/bmstu-iu9/ptp2022-8-todo-list/backend/internal/config"
	"github.com/bmstu-iu9/ptp2022-8-todo-list/backend/internal/log"
	_ "github.com/lib/pq"
)

var (
	host     = config.Get("DB_HOST")
	port     = config.Get("DB_PORT")
	user     = config.Get("DB_USER")
	dbName   = config.Get("DB_NAME")
	password = config.Get("DB_PASSWORD")
	sslMode  = config.Get("DB_SSL_MODE")
)

func New(logger log.Logger) (*sql.DB, error) {
	params := fmt.Sprintf(
		"host=%s port=%s user=%s dbname=%s password=%s sslmode=%s",
		host, port, user, dbName, password, sslMode)
	logger.Debug("Connecting to DB:", params)
	db, err := sql.Open("postgres", params)
	if err != nil {
		return nil, err
	}

	logger.Debug("Creating new users table and test user")
	_, err = db.Exec(`
DROP TABLE IF EXISTS users CASCADE;
CREATE TABLE users (
       id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
       email varchar(255) UNIQUE NOT NULL,
       nickname varchar(45) NOT NULL,
       password varchar(100) NOT NULL
);
INSERT INTO users (email, nickname, password) VALUES 
('test@example.com', 'test', 'Test123Test'),
('test2@example.com', 'test2', 'Test123Test');
`)
	if err != nil {
		return nil, err
	}

	logger.Debug("Creating new tasks table and test task")
	_, err = db.Exec(`
DROP TABLE IF EXISTS tasks CASCADE;
DROP TYPE IF EXISTS status;
CREATE TYPE status AS ENUM ('in progress', 'done', 'outdated');
CREATE TABLE tasks (
	id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	user_id int REFERENCES users,
	name varchar(255) NOT NULL,
	description text,
	created_on timestamp(3) NOT NULL,
	due_date timestamp(3) NOT NULL,
	schtirlich_humorescue text,
	labels text,
	cur_status status NOT NULL DEFAULT 'in progress'
);
INSERT INTO tasks(user_id, name, description, created_on, due_date, schtirlich_humorescue, labels, cur_status)
VALUES (
	1,  -- user_id
	'test_name',  -- name
	'test_description',  -- description
	'2000-01-01T00:00:00.000Z',  -- created_on
	'2000-01-01T00:00:00.000Z',  -- due_date
	'test_humorescue',  -- schtirlich_humorescue
	'[{"text":"test_name","color":"#000000"}]',  -- labels
	'in progress'  -- status
);
`)

	if err != nil {
		return nil, err
	}

	_, err = db.Exec(`
DROP TYPE IF EXISTS rarity CASCADE;
CREATE TYPE rarity AS ENUM ('common','rare','epic','legendary');
DROP TYPE IF EXISTS category CASCADE;
CREATE TYPE category AS ENUM ('armor','weapon','pet','skin');
DROP TABLE IF EXISTS items CASCADE;
CREATE TABLE items (
    id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name varchar(50) UNIQUE NOT NULL,
    image_src varchar (255) UNIQUE NOT NULL,
    image_for_hero varchar (255) UNIQUE NOT NULL,
    description text NOT NULL,
    price int NOT NULL,
    item_category category NOT NULL,
    item_rarity rarity NOT NULL,
    armor int NOT NULL,
    damage int NOT NULL
);
INSERT INTO items (name, image_src,image_for_hero, description, price, item_category, item_rarity,armor,damage)
 VALUES 
('testItem1', 'test.png', 'test.png', 'test1', 65, 'armor', 'rare',10,10),
('testItem2', 'test2.png', 'test2.png', 'test2', 62, 'weapon', 'epic',0,5),
('testItem3', 'test3.png', 'test3.png', 'test3', 69, 'weapon', 'legendary',5,0);
`)
	if err != nil {
		return nil, err
	}
	_, err = db.Exec(`
DROP TYPE IF EXISTS states CASCADE;
CREATE TYPE states AS ENUM ('equipped', 'inventoried', 'store');
DROP TABLE IF EXISTS inventory;
CREATE TABLE inventory (
    user_id int,
    item_id int,
    item_state states DEFAULT 'store',
    FOREIGN KEY (user_id) REFERENCES users (id),
    FOREIGN KEY (item_id) REFERENCES items (id)
);
INSERT INTO inventory (user_id, item_id, item_state) VALUES 
(1, 1, 'inventoried'),
(2, 1, 'equipped'),
(1, 2, 'equipped');
`)
	return db, err
}
