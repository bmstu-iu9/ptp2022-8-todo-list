package db

import (
	"database/sql"
	"fmt"

	"github.com/bmstu-iu9/ptp2022-8-todo-list/backend/internal/config"
	_ "github.com/lib/pq"
)

var (
	db  *sql.DB
	err error

	host     = config.Get("DB_HOST")
	port     = config.Get("DB_PORT")
	user     = config.Get("DB_USER")
	dbName   = config.Get("DB_NAME")
	password = config.Get("DB_PASSWORD")
	sslMode  = config.Get("DB_SSL_MODE")
)

func init() {
	db, err = sql.Open("postgres",
		fmt.Sprintf("host=%s port=%s user=%s dbname=%s password=%s sslmode=%s",
			host, port, user, dbName, password, sslMode))
	if err != nil {
		return
	}

	_, err = db.Exec(`
DROP TABLE IF EXISTS users;
CREATE TABLE users (
       id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
       email varchar(255) UNIQUE NOT NULL,
       nickname varchar(45) NOT NULL,
       password varchar(100) NOT NULL
);
INSERT INTO users(email, nickname, password)
VALUES('test@example.com', 'test', 'Test123Test');
`)

	_, err = db.Exec(`
DROP TABLE IF EXISTS items;
CREATE TABLE items (
    item_id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    item_name varchar(255) UNIQUE NOT NULL,
    image_src varchar (255) UNIQUE NOT NULL,
    decription text,
    price int NOT NULL,
    category varchar (30),
    rarity varchar (30),
);
INSERT INTO items (item_name) VALUES ('testItem1');
INSERT INTO items (item_name) VALUES ('testItem2');
`)

	_, err = db.Exec(`
DROP TABLE IF EXISTS users_and_items;
CREATE TABLE users_and_items (
    user_id INTEGER REFERENCES users (id),
    item_id INTEGER REFERENCES items (item_id)
);
INSERT INTO users_and_items (user_id, item_id) VALUES (1,1);
INSERT INTO users_and_items (user_id, item_id) VALUES (1,2);
`)

}

func New() (*sql.DB, error) {
	return db, err
}
